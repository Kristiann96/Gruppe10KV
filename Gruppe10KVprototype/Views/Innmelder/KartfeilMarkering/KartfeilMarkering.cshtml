@{
    ViewData["Title"] = "Marker feil på kart";
    Layout = "_Layout";
}

@section Styles {
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

        <style>
            #map {
                height: 85vh;
                width: 100%;
                margin-bottom: 20px;
            }

            .button-container {
                position: fixed;
                bottom:120 px;
                right: 20px;
                z-index: 1000;
                display: flex;
                gap: 10px;
            }

            .custom-button, .kommune-button {
                background-color: #FF5733;
                border: none;
                color: white;
                padding: 12px 24px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                cursor: pointer;
                border-radius: 4px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }

            .custom-button:hover, .kommune-button:hover {
                background-color: #FF6F61;
                transform: translateY(-1px);
                box-shadow: 0 3px 6px rgba(0,0,0,0.25);
            }

            .custom-button:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }
        </style>
}

<div class="container-fluid p-0">
    <div class="button-container">
        <button onclick="toggleKommuneGrenser()" id="kommuneButton" class="kommune-button">
            Vis kommunegrenser
        </button>
        <form method="get" action="@Url.Action("KartfeilSkjema", "KartfeilSkjema")" class="d-inline">
            <input type="hidden" id="geoJsonHidden" name="geoJson" />
            <button type="submit" id="sendGeometri" class="custom-button" disabled>
                Gå til skjema
            </button>
        </form>
    </div>

    <div id="map"></div>
</div>

@section Scripts {
        <!-- JavaScript biblioteker -->
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

        <!-- Våre konfigurasjonsfiler -->
        <script src="~/js/maps/config/mapConfig.js"></script>
        <script src="~/js/maps/config/drawConfig.js"></script>
        <script src="~/js/maps/services/wmsService.js"></script>
        <script src="~/js/maps/utils/mapControls.js"></script>

        <script>
            // Initialiser kartet
            const map = MapConfig.initializeMap('map', [62.1995, 6.1286], 15);

            // Initialiser tegning
            const drawnItems = DrawConfig.initializeDrawControl(map);

            // Initialiser søk og lokalisering
            MapControls.initializeControls(map);

            // Variable for å holde styr på kommunegrenselag
            let kommuneGrenser = null;

            // Funksjon for å toggle kommunegrenser
            function toggleKommuneGrenser() {
                if (kommuneGrenser) {
                    map.removeLayer(kommuneGrenser);
                    kommuneGrenser = null;
                    document.getElementById('kommuneButton').textContent = 'Vis kommunegrenser';
                } else {
                    kommuneGrenser = WMSService.addKommuneGrenser(map);
                    document.getElementById('kommuneButton').textContent = 'Skjul kommunegrenser';
                }
            }

            // Håndter tegning og lagring av GeoJSON
            map.on(L.Draw.Event.CREATED, function (event) {
                drawnItems.clearLayers(); // Fjerner eksisterende tegning
                const layer = event.layer;
                drawnItems.addLayer(layer);
                const geoJsonData = layer.toGeoJSON();
                document.getElementById('geoJsonHidden').value = JSON.stringify(geoJsonData);
                document.getElementById('sendGeometri').disabled = false; // Aktiver knappen
            });
        </script>
}
