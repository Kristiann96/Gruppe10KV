@model ViewModels.BidraTilKartForbedringViewModel
@{
    ViewData["Title"] = "Bidra til kartforbedring";
    Layout = "_Layout";
}

@section Styles {
    <!-- Basis kart-styling - IKKE ENDRE -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

    <style>
        /* Basis kartoppsett - IKKE ENDRE */
        #map {
            height: 85vh;
            width: 100%;
            margin-bottom: 20px;
        }

        /* Popup styling - Kan justeres */
        .persistent-popup .leaflet-popup-content-wrapper {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }

        .persistent-popup .leaflet-popup-tip {
            background-color: rgba(255, 255, 255, 0.95);
        }

        .popup-content {
            min-width: 200px;
            padding: 10px;
        }

        .popup-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* Vurderingsknapper og kommentarfelt */
        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .popup-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .bekreft-button {
            background-color: #4CAF50;
            color: white;
        }

        .avkreft-button {
            background-color: #f44336;
            color: white;
        }

        .kommentar-container {
            display: none;
            margin-top: 10px;
        }

        .kommentar-textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 60px;
        }

        .send-button {
            background-color: #2196F3;
            color: white;
            width: 100%;
        }

        .takk-melding {
            text-align: center;
            color: #4CAF50;
            font-weight: bold;
            padding: 10px;
        }

        /* Validerings-melding styling */
        .validation-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Visuell indikator for geometrier */
        .geometry-indicator {
    background-color: #ff7800;
    border: 2px solid #ffffff;
    box-shadow: 0 0 4px rgba(0,0,0,0.5);
}

    </style>
}

<div class="container-fluid p-0">
    <div id="map"></div>
    <div id="validationMessage" class="validation-message"></div>
</div>

@section Scripts {
    <!-- Nødvendige scripts - IKKE ENDRE -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

    <script src="~/js/maps/config/mapConfig.js"></script>
    <script src="~/js/maps/services/wmsService.js"></script>
    <script src="~/js/maps/utils/mapControls.js"></script>

    <script>
        // Kart-initialisering
       const map = MapConfig.initializeMap('map');
const baseMaps = {};
const overlayMaps = WMSService.createAllLayers();
L.control.layers(baseMaps, overlayMaps).addTo(map);
MapControls.initializeControls(map);

        // Globale variabler for tilstandshåndtering
        let hoverTimer;
        let popupTimer;
        const vurdertGeometrier = new Set();
        let aktivVurdering = false;
        let isPopupOpen = false;

        // Hent geometridata
        const geometriData = @Html.Raw(Model.GetGeometriDataAsJson());

        // Hjelpefunksjoner
        function showMessage(message, isError = false) {
            const messageElement = document.getElementById('validationMessage');
            messageElement.textContent = message;
            messageElement.style.display = 'block';
            messageElement.style.backgroundColor = isError ? '#f44336' : '#4CAF50';

            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        function addVisualIndicator(layer, type) {
            if (type === 'LineString' || type === 'Polygon') {
                const bounds = layer.getBounds();
                const center = bounds.getCenter();

                const marker = L.circleMarker(center, {
                    radius: 12,           // Større radius
                    fillColor: '#fc03ec', // rosa fyll
                    color: '##fcd7fa',     // lyserosa kant
                    weight: 4,            // Tykkere kant
                    opacity: 1,
                    fillOpacity: 0.9      // Mer solid farge
                }).addTo(map);

                return marker;
            }
            return null;
        }

        function createPopupContent(data) {
            const container = document.createElement('div');
            container.className = 'popup-content';

            // Tittel
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = data.Tittel;
            container.appendChild(title);

            // Hvis allerede vurdert i denne sesjonen
            if (vurdertGeometrier.has(data.InnmeldingId)) {
                const takkDiv = document.createElement('div');
                takkDiv.className = 'takk-melding';
                takkDiv.textContent = 'Takk for din vurdering!';
                container.appendChild(takkDiv);
                return container;
            }

            // Knapper-container
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'popup-buttons';

            // Kommentar-container
            const kommentarDiv = document.createElement('div');
            kommentarDiv.className = 'kommentar-container';

            // Bekreft/Avkreft knapper
            const bekreftBtn = document.createElement('button');
            bekreftBtn.className = 'popup-button bekreft-button';
            bekreftBtn.textContent = 'Bekreft';

            const avkreftBtn = document.createElement('button');
            avkreftBtn.className = 'popup-button avkreft-button';
            avkreftBtn.textContent = 'Avkreft';

            buttonsDiv.appendChild(bekreftBtn);
            buttonsDiv.appendChild(avkreftBtn);
            container.appendChild(buttonsDiv);

            // Kommentar elementer
            const textarea = document.createElement('textarea');
            textarea.className = 'kommentar-textarea';
            textarea.placeholder = 'Skriv en kort kommentar...';

            const sendBtn = document.createElement('button');
            sendBtn.className = 'popup-button send-button';
            sendBtn.textContent = 'Send vurdering';

            kommentarDiv.appendChild(textarea);
            kommentarDiv.appendChild(sendBtn);
            container.appendChild(kommentarDiv);

            let valgtType = null;

            // Knappehåndtering
            bekreftBtn.onclick = () => {
                valgtType = 'bekreftelse';
                aktivVurdering = true;
                buttonsDiv.style.display = 'none';
                kommentarDiv.style.display = 'block';
                clearTimeout(popupTimer);
            };

            avkreftBtn.onclick = () => {
                valgtType = 'avkreftelse';
                aktivVurdering = true;
                buttonsDiv.style.display = 'none';
                kommentarDiv.style.display = 'block';
                clearTimeout(popupTimer);
            };

            // Send-knapp håndtering
            sendBtn.onclick = async () => {
                const kommentar = textarea.value.trim();

                try {
                    const response = await fetch('/BidraTilKartForbedring/LagreVurdering', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            innmeldingId: data.InnmeldingId,
                            type: valgtType,
                            kommentar: kommentar
                        })
                    });

                    if (response.ok) {
                        vurdertGeometrier.add(data.InnmeldingId);
                        aktivVurdering = false;
                        kommentarDiv.style.display = 'none';

                        const takkDiv = document.createElement('div');
                        takkDiv.className = 'takk-melding';
                        takkDiv.textContent = 'Takk for din vurdering!';
                        container.innerHTML = '';
                        container.appendChild(title);
                        container.appendChild(takkDiv);

                        showMessage('Takk for ditt bidrag!');
                    } else {
                        showMessage('Det oppstod en feil ved lagring av vurderingen.', true);
                    }
                } catch (error) {
                    showMessage('Det oppstod en feil ved sending av vurderingen.', true);
                }
            };

            return container;
        }

        // Legg til geometrier på kartet
        geometriData.forEach(function (data) {
            try {
                const geoJsonFeature = JSON.parse(data.GeometriGeoJson);
                const layer = L.geoJSON(geoJsonFeature, {
                    style: function (feature) {
                        return {
                            color: '#05ede9',     // Orange
                            weight: 8,            // Tykkere linjer
                            opacity: 0.9,         // Mer solid
                            fillColor: '#fa05ed', // Orange fyll for polygoner
                            fillOpacity: 0.4      // Semi-transparent fyll
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        // Få bounds for laget, uansett geometritype
                        const bounds = layer.getBounds();
                        // Bruk senterpunktet for å plassere markøren
                        const center = bounds.getCenter();

                        // Legg til markør på senterpunktet
                        const marker = L.marker(center).addTo(map);

                        // Opprett popup
                        const popup = L.popup({
                            closeButton: true,
                            closeOnClick: false,
                            autoClose: false,
                            className: 'persistent-popup'
                        });

                        popup.setContent(createPopupContent(data));

                        // Bind popup til både layer og markør
                        layer.bindPopup(popup);
                        marker.bindPopup(popup);

                        let hoverTimeout;

                        // Håndter hover events for både layer og markør
                        const handleMouseOver = function () {
                            if (hoverTimeout) clearTimeout(hoverTimeout);

                            hoverTimeout = setTimeout(() => {
                                if (!isPopupOpen) {
                                    layer.openPopup();
                                    isPopupOpen = true;
                                }
                            }, 500);
                        };

                        const handleMouseOut = function (e) {
                            if (hoverTimeout) clearTimeout(hoverTimeout);

                            const popup = document.querySelector('.leaflet-popup');
                            if (popup) {
                                const rect = popup.getBoundingClientRect();
                                const mouseX = e.originalEvent.clientX;
                                const mouseY = e.originalEvent.clientY;

                                if (mouseX >= rect.left && mouseX <= rect.right &&
                                    mouseY >= rect.top && mouseY <= rect.bottom) {
                                    return;
                                }
                            }

                            if (!aktivVurdering) {
                                layer.closePopup();
                                isPopupOpen = false;
                            }
                        };

                        // Legg til hover events på både layer og markør
                        layer.on('mouseover', handleMouseOver);
                        layer.on('mouseout', handleMouseOut);
                        marker.on('mouseover', handleMouseOver);
                        marker.on('mouseout', handleMouseOut);
                    }
                }).addTo(map);

                // Legg til popup mouseover/mouseout håndtering
                const popup = layer.getPopup();
                if (popup) {
                    popup.on('add', function () {
                        const popupElement = document.querySelector('.leaflet-popup');
                        if (popupElement) {
                            popupElement.addEventListener('mouseover', function () {
                                isPopupOpen = true;
                            });

                            popupElement.addEventListener('mouseout', function (e) {
                                if (!aktivVurdering) {
                                    const rect = this.getBoundingClientRect();
                                    if (e.clientX < rect.left || e.clientX > rect.right ||
                                        e.clientY < rect.top || e.clientY > rect.bottom) {
                                        isPopupOpen = false;
                                        layer.closePopup();
                                    }
                                }
                            });
                        }
                    });
                }

                // Legg til visuell indikator for mindre synlige geometrier
                const circleMarker = addVisualIndicator(layer, geoJsonFeature.geometry.type);
                if (circleMarker) {
                    circleMarker.bindPopup(popup);

                    // Samme hover-oppførsel for sirkelmarkøren
                    circleMarker.on('mouseover', function (e) {
                        if (hoverTimeout) clearTimeout(hoverTimeout);
                        hoverTimeout = setTimeout(() => {
                            if (!aktivVurdering) {
                                this.openPopup();
                            }
                        }, 500);
                    });

                    circleMarker.on('mouseout', function (e) {
                        if (hoverTimeout) clearTimeout(hoverTimeout);
                        if (!aktivVurdering) {
                            this.closePopup();
                        }
                    });
                }

            } catch (e) {
                console.error('Feil ved parsing av geometri:', e, data);
            }
        });
    </script>
}