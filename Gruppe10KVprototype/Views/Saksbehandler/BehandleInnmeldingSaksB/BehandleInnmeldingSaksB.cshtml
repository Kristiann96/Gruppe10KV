@model ViewModels.BehandleInnmeldingSaksBViewModel
<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innmelding Detaljer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
</head>
<body>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const saveButton = document.getElementById('saveButton');
        const originalValues = {
            status: form.querySelector('#statusDropdown').value,
            prioritet: form.querySelector('#prioritetDropdown').value,
            kartType: form.querySelector('#kartTypeDropdown').value
        };

        function checkForChanges() {
            const currentValues = {
                status: form.querySelector('#statusDropdown').value,
                prioritet: form.querySelector('#prioritetDropdown').value,
                kartType: form.querySelector('#kartTypeDropdown').value
            };

            const hasChanges = Object.keys(originalValues).some(key => originalValues[key] !== currentValues[key]);
            saveButton.disabled = !hasChanges;
        }

        form.querySelector('#statusDropdown').addEventListener('change', checkForChanges);
        form.querySelector('#prioritetDropdown').addEventListener('change', checkForChanges);
        form.querySelector('#kartTypeDropdown').addEventListener('change', checkForChanges);

        //Sjekker om dropdown verdi er endret. 
        checkForChanges();
    });
</script>
    <div class="container">
        <div class="info-panel">
            @if (Model?.InnmeldingModel != null)
            {
                <h2>@Model.InnmeldingModel.Tittel</h2>
                    <form asp-action="OppdateringAvInnmeldingSaksB" asp-route-id="@Model.InnmeldingModel.InnmeldingId" method="post">
                    <div class="status-info">
                        <div class="form-group mb-3">
                            <label for="statusDropdown">Status:</label>
                            <select id="statusDropdown" class="form-control" asp-for="InnmeldingModel.Status" asp-items="Model.StatusOptions">
                                <option value="">Velg status</option>
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="prioritetDropdown">Prioritet:</label>
                            <select id="prioritetDropdown" class="form-control" asp-for="InnmeldingModel.Prioritet" asp-items="Model.PrioritetOptions">
                                <option value="">Velg prioritet</option>
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="kartTypeDropdown">Kart Type:</label>
                            <select id="kartTypeDropdown" class="form-control" asp-for="InnmeldingModel.KartType" asp-items="Model.KartTypeOptions">
                                <option value="">Velg kart type</option>
                            </select>
                        </div>

                        <p>Sist endret: @Model.InnmeldingModel.SisteEndring.ToString("dd.MM.yyyy HH:mm")</p>
                
                        @if (TempData["Kommunenavn"] != null && TempData["Kommunenummer"] != null)
                        {
                            <p>Kommune: <span class="badge">@TempData["Kommunenavn"] (@TempData["Kommunenummer"])</span></p>
                        }

                        <div class="form-group mt-4">
                            <button type="submit" id="saveButton" class="btn btn-primary">Lagre endringer</button>
                        </div>
                    </div>
                </form>
                <div class="description">
                    <h3>Beskrivelse</h3>
                    <p>@Model.InnmeldingModel.Beskrivelse</p>
                </div>
                <div class="reporter-info">
                    <h3>Innmelder</h3>
                    @if (Model.InnmelderModel != null && Model.PersonModel != null)
                    {
                        <p>Type: @Model.InnmelderModel.InnmelderType</p>
                        <p>Navn: @Model.PersonModel.Fornavn @Model.PersonModel.Etternavn</p>
                        <p>Telefon: @Model.PersonModel.Telefonnummer</p>
                    }
                    else if (Model.InnmeldingModel.GjestInnmelderId.HasValue)
                    {
                        <p>Gjesteinnmelder</p>
                    }
                    else
                    {
                        <p>Ingen innmelder informasjon tilgjengelig</p>
                    }
                </div>
                @if (Model.SaksbehandlerModel != null)
                {
                    <div class="handler-info">
                        <h3>Saksbehandler</h3>
                        <p>Stilling: @Model.SaksbehandlerModel.Stilling</p>
                        <p>E-post: @Model.SaksbehandlerModel.Jobbepost</p>
                        <p>Telefon: @Model.SaksbehandlerModel.Jobbtelefon</p>
                    </div>
                }
            }
            else
            {
                <p>Ingen innmeldingsdetaljer tilgjengelig</p>
            }
        </div>
        <div id="map" style="height: 500px;"></div>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="~/js/maps/config/mapConfig.js"></script>
    <script src="~/js/maps/utils/mapControls.js"></script>
<script>
        const map = MapConfig.initializeMap('map');
        MapControls.initializeSearch(map);
        @if (Model?.Geometri != null && !string.IsNullOrEmpty(Model.Geometri.GeometriGeoJson))
        {
            <text>
                    const geoJsonFeature = JSON.parse('@Html.Raw(Model.Geometri.GeometriGeoJson)');
                    const geoJsonLayer = L.geoJSON(geoJsonFeature).addTo(map);
                    map.fitBounds(geoJsonLayer.getBounds());
            </text>
        }
    </script>
<!-- Form handling script -->
<script>
    // Error handling
    @if (TempData["ErrorMessage"] != null)
    {
        <text>
            alert('@TempData["ErrorMessage"]');
        </text>
    }

    // Form submit handling
    document.querySelector('form').addEventListener('submit', function() {
        const button = document.getElementById('saveButton');
        button.textContent = 'Lagrer...';
        button.disabled = true;
    });

    // Success handling
    @if (TempData["SuccessMessage"] != null)
    {
        <text>
            const button = document.getElementById('saveButton');
            button.textContent = 'Lagret!';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');
            
            // Reset after 5 seconds
            setTimeout(() => {
                button.textContent = 'Lagre endringer';
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
                button.disabled = false;
            }, 5000);
        </text>
    }
</script>
</body>
</html>